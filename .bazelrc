# Display rc options when building
build --announce_rc
# Enable build:{linux,mac,windows} directives in the rc file
build --enable_platform_specific_config

# C++ Version
build:freebsd --cxxopt=-std=c++17 --linkopt=-std=c++17
build:linux --cxxopt=-std=c++17 --linkopt=-std=c++17
build:macos --cxxopt=-std=c++17 --linkopt=-std=c++17
build:windows --cxxopt=/std:c++17 --linkopt=/std:c++17

# FreeBSD-specific options
# Link with libm, which is separated from libc on FreeBSD
build:freebsd --linkopt=-lm
# Position-independent code
build:freebsd --copt=-fPIC
# Build gRPC with fork support.
build:freebsd --copt=-DGRPC_POSIX_FORK_ALLOW_PTHREAD_ATFORK
# Java Version
# The Bazel remote_jdk11 target doesn't exist for FreeBSD, so we rely on a
# locally installed JDK.
build:freebsd --define=ABSOLUTE_JAVABASE=/usr/local/openjdk11
build:freebsd --host_javabase=@bazel_tools//tools/jdk:absolute_javabase
build:freebsd --javabase=@bazel_tools//tools/jdk:absolute_javabase
build:freebsd --host_java_toolchain=@bazel_tools//tools/jdk:toolchain_vanilla
build:freebsd --java_toolchain=@bazel_tools//tools/jdk:toolchain_vanilla

# Linux-specific options
# Position-independent code
build:linux --copt=-fPIC
# Build gRPC with fork support.
build:linux --copt=-DGRPC_POSIX_FORK_ALLOW_PTHREAD_ATFORK
# Java Version
build:linux --host_javabase=@bazel_tools//tools/jdk:remote_jdk11
build:linux --javabase=@bazel_tools//tools/jdk:remote_jdk11
build:linux --host_java_toolchain=@bazel_tools//tools/jdk:toolchain_java11
build:linux --java_toolchain=@bazel_tools//tools/jdk:toolchain_java11

# macOS-specific options
# Ensure compatibility with all macOS versions that support C++17.
build:macos --copt=-mmacosx-version-min=10.15
# Workaround for release bug in Bazel 4.0.0 for macos: https://github.com/bazelbuild/bazel/pull/12882
build:macos --features=-debug_prefix_map_pwd_is_dot
# Workaround for build issue: https://github.com/bazelbuild/bazel/issues/4341#issuecomment-572050759
build:macos --copt=-DGRPC_BAZEL_BUILD
# Workaround for build issue: https://github.com/bazelbuild/bazel/issues/4341#issuecomment-758361769
build:macos --features=-supports_dynamic_linker
# Build gRPC with fork support.
build:macos --copt=-DGRPC_POSIX_FORK_ALLOW_PTHREAD_ATFORK
# Java Version
build:macos --host_javabase=@bazel_tools//tools/jdk:remote_jdk11
build:macos --javabase=@bazel_tools//tools/jdk:remote_jdk11
build:macos --host_java_toolchain=@bazel_tools//tools/jdk:toolchain_java11
build:macos --java_toolchain=@bazel_tools//tools/jdk:toolchain_java11

# Windows-specific options
# Prevent glog symbols from being exported with `__declspec(dllexport)`
build:windows --cxxopt=/DGOOGLE_GLOG_DLL_DECL=
# Prevent glog from conflicting with windows.h
# https://code.google.com/archive/p/google-glog/issues/33
build:windows --cxxopt=/DGLOG_NO_ABBREVIATED_SEVERITIES
# Java Version
build:windows --host_javabase=@bazel_tools//tools/jdk:remote_jdk11
build:windows --javabase=@bazel_tools//tools/jdk:remote_jdk11
build:windows --host_java_toolchain=@bazel_tools//tools/jdk:toolchain_java11
build:windows --java_toolchain=@bazel_tools//tools/jdk:toolchain_java11

# x86 builds on amd64
build:m32 --copt=-m32 --linkopt=-m32 --test_tag_filters=-no_m32

build:san --build_tests_only
build:san --test_tag_filters=-no_san
build:san --strip=never
build:san --copt=-DGPR_NO_DIRECT_SYSCALLS

build:asan --config=san
build:asan --copt=-fsanitize=address
build:asan --copt=-fsanitize=undefined
build:asan --copt=-O0
build:asan --copt=-fno-omit-frame-pointer
build:asan --copt=-DGRPC_ASAN
build:asan --copt=-DGRPC_UBSAN
build:asan --copt=-DADDRESS_SANITIZER  # used by absl
build:asan --linkopt=-fsanitize=address
build:asan --linkopt=-fsanitize=undefined
build:asan --action_env=ASAN_OPTIONS=detect_leaks=1:color=always

build:tsan --config=san
build:tsan --copt=-fsanitize=thread
build:tsan --copt=-fno-omit-frame-pointer
build:tsan --copt=-DGRPC_TSAN
build:tsan --linkopt=-fsanitize=thread

build:fips --copt=-DBORINGSSL_FIPS
build:fips --define=fips=1
build:fips --repo_env=KMSP11_FIPS=1

# Import from user.bazelrc if it exists. Keep this at the end of the file so
# that local options can override options that are declared in this file.
# https://docs.bazel.build/versions/master/best-practices.html#using-the-bazelrc-file
try-import %workspace%/user.bazelrc
